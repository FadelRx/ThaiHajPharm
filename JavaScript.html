<script>
    let currentUser = null;
    let patients = [];
    let editingIndex = null;
    document.addEventListener("DOMContentLoaded", () => {
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      // ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      setTimeout(() => {
        Swal.close(); // ‡∏õ‡∏¥‡∏î SweetAlert ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      }, 2000);
    });

    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      google.script.run.withSuccessHandler(response => {
        Swal.close();
        if (response.success) {
          currentUser = response.user; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ currentUser
          document.getElementById('loggedInUser').textContent = currentUser.hospital;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('mainSection').style.display = 'block';

          loadPatients(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ
          loadUserStatistics(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏™‡∏ß‡∏á‡∏ö‡∏∏‡∏ç
        } else {
          Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
        }
      }).login(username, password);
    }

    function loadPatients() {
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      google.script.run.withSuccessHandler(data => {
        Swal.close(); // ‡∏õ‡∏¥‡∏î SweetAlert ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        patients = data;
        renderPatientsTable();
      }).getPatients(currentUser);
    }


     // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function renderPatientsTable() {
      const tableBody = document.getElementById("patientsTable");
      tableBody.innerHTML = "";

      let totalPatientsCount = 0; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Group By

      const groupedPatients = patients.reduce((groups, patient) => {
        if (!groups[patient.hospital]) {
          groups[patient.hospital] = [];
        }
        groups[patient.hospital].push(patient);
        return groups;
      }, {});

      Object.keys(groupedPatients).forEach(hospital => {
        const groupHeaderRow = document.createElement("tr");
        groupHeaderRow.setAttribute('data-group', 'true'); // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ Group By
        groupHeaderRow.innerHTML = `
          <td colspan="5" style="background-color: #eceff1; font-weight: bold; text-align: left;">
            ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•: ${hospital}
          </td>
        `;
        tableBody.appendChild(groupHeaderRow);

        groupedPatients[hospital].forEach((patient, index) => {
          const row = document.createElement("tr");

          let statusClass = '';
          let warningIcon = '';
          switch (patient.status) {
            case '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß':
              statusClass = 'status-green';
              break;
            case '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á':
              statusClass = 'status-yellow';
              break;
            case '‡πÅ‡∏î‡∏á':
              statusClass = 'status-red';
              warningIcon = `<span class="warning-icon">‚ö†Ô∏è</span>`;
              break;
            case '‡πÄ‡∏ó‡∏≤':
              statusClass = 'status-gray';
              warningIcon = `<span class="warning-icon">‚ö†Ô∏è</span>`;
              break;
          }

          row.innerHTML = `
            <td>${patient.name}</td>
            <td>${patient.hospital}</td>
            <td><span class="status-circle ${statusClass}"></span>${patient.status} ${warningIcon}</td>
            <td>${patient.drugIssues.replace(/, /g, ', ')}</td> <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î -->
            <td class="text-center">
              <div class="d-flex justify-content-center">
                <!-- ‡∏õ‡∏∏‡πà‡∏° Information -->
                <div class="btn-group me-3"> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° margin-right (me-3) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á -->
                  <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Information
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="showPatientDetails(${index})">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a></li>
                    ${
                      currentUser.hospital !== 'Admin'
                        ? `
                          <li><a class="dropdown-item" href="#" onclick="editPatient(${index})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a></li>
                          <li><a class="dropdown-item text-danger" href="#" onclick="deletePatient(${index})">‚ûñ ‡∏•‡∏ö</a></li>
                        `
                        : ''
                    }
                  </ul>
                </div>

                <!-- ‡∏õ‡∏∏‡πà‡∏° Care -->
                <div class="btn-group">
                  <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Care
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="openCareForm(${index})">‚ôªÔ∏è Pharm Care+</a></li>
                    <li><a class="dropdown-item" href="#" onclick="viewCareDetails(${index})">üìú Care Detail</a></li>
                  </ul>
                </div>
              </div>
            </td>

          `;
          tableBody.appendChild(row);

          totalPatientsCount++; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß
        });
      });

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô DOM
      document.getElementById('filteredCount').textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î DRP: ${totalPatientsCount}`;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    function showPatientDetails(index) {
      const patient = patients[index];
      const modal = new bootstrap.Modal(document.getElementById("patientModal"));
      document.getElementById("patientDetails").innerHTML = `
        <strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${patient.name}<br>
        <strong>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•:</strong> ${patient.hospital}<br>
        <strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${patient.address}<br>
        <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û:</strong> ${patient.status}<br>
        <strong>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> ${patient.disease}<br>
        <strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</strong> ${patient.symptoms}<br>
        <strong>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</strong> ${patient.company}<br>
        <strong>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤:</strong> ${patient.drugIssues}<br>
        <strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${patient.detail}
      `;
      modal.show();
    }

    function openAddForm() {
      editingIndex = null;
      document.getElementById('formSection').style.display = 'block';
      document.getElementById('mainSection').style.display = 'none';
      document.getElementById('formTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ';
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô editPatient
    function editPatient(index) {
      const patient = patients[index];

      document.getElementById('name').value = patient.name;
      document.getElementById('address').value = patient.address;
      document.getElementById('hospital').value = patient.hospital;
      document.getElementById('status').value = patient.status;
      document.getElementById('disease').value = patient.disease;
      document.getElementById('symptoms').value = patient.symptoms;
      document.getElementById('company').value = patient.company;

      const selectedIssues = patient.drugIssues.split(', '); // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå
      document.querySelectorAll('#drugIssuesContainer input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = selectedIssues.includes(checkbox.value); // ‡∏ï‡∏¥‡πä‡∏Å Checkbox ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      });

      document.getElementById('detail').value = patient.detail || '';

      editingIndex = index; // ‡πÄ‡∏Å‡πá‡∏ö index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      document.getElementById('formSection').style.display = 'block';
      document.getElementById('mainSection').style.display = 'none';
    }

    function deletePatient(index) {
      const patient = patients[index];

      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
        text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏•‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
          });

          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          google.script.run.withSuccessHandler(response => {
            Swal.close();
            if (response.success) {
              patients.splice(index, 1); // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
              renderPatientsTable(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á
              Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } else {
              Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', response.message, 'error');
            }
          }).deletePatient(patient.uniqueId);
        }
      });
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô savePatient
      function savePatient() {
      if (currentUser.hospital === 'Admin') {
        Swal.fire("‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï", "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "warning");
        return;
      }

      const selectedIssues = Array.from(document.querySelectorAll('#drugIssuesContainer input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value); // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Checkbox ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡πä‡∏Å

      const patient = {
        uniqueId: editingIndex !== null ? patients[editingIndex].uniqueId : null, // ‡πÉ‡∏ä‡πâ UniqueID ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        name: document.getElementById('name').value,
        address: document.getElementById('address').value,
        hospital: currentUser.hospital || 'Admin',
        status: document.getElementById('status').value,
        disease: document.getElementById('disease').value,
        symptoms: document.getElementById('symptoms').value,
        company: document.getElementById('company').value,
        drugIssues: selectedIssues.join(', '), // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤
        detail: document.getElementById('detail').value,
      };

      if (editingIndex !== null) {
        patients[editingIndex] = patient; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå
      } else {
        patient.uniqueId = generateUniqueId(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á UniqueID ‡πÉ‡∏´‡∏°‡πà
        patients.push(patient); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå
      }

      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      google.script.run.withSuccessHandler(() => {
        Swal.close();
        renderPatientsTable();
        clearForm();
        cancelForm();
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
      }).savePatients(patients, currentUser);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á UniqueID ‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á JavaScript (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
    function generateUniqueId() {
      return 'H' + Math.random().toString(36).substr(2, 9);
    }

    function cancelForm() {
      document.getElementById('formSection').style.display = 'none';
      document.getElementById('mainSection').style.display = 'block';
      clearForm();
    }

    function logout() {
      currentUser = null; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentUser
      document.getElementById("loginSection").style.display = "block"; // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô login
      document.getElementById("mainSection").style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å
      document.getElementById("formSection").style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°)
      
      Swal.fire({
        title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        icon: 'success',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
      });
    }

    function clearForm() {
      document.getElementById('name').value = '';
      document.getElementById('address').value = '';
      document.getElementById('hospital').value = currentUser.hospital || 'Admin';
      document.getElementById('status').value = '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß'; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      document.getElementById('disease').value = '';
      document.getElementById('symptoms').value = '';
      document.getElementById('company').value = '';
      document.getElementById('detail').value = '';

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡∏≤‡∏Å 'drugIssuesContainer' ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô DOM
      const drugIssuesCheckboxes = document.querySelectorAll('#drugIssuesContainer input[type="checkbox"]');
      if (drugIssuesCheckboxes) {
        drugIssuesCheckboxes.forEach(checkbox => checkbox.checked = false);
      }
    }


    function loadHospitals() {
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
      });

      google.script.run.withSuccessHandler(hospitals => {
        Swal.close();
        const regHospital = document.getElementById("regHospital");
        regHospital.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• --</option>';
        hospitals.forEach(hospital => {
          const option = document.createElement("option");
          option.value = hospital;
          option.textContent = hospital;
          regHospital.appendChild(option);
        });
      }).getHospitals();
    }
    
    function showRegister() {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("registerSection").style.display = "block";
      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Register
      loadHospitals();
    }

    function showLogin() {
      document.getElementById("registerSection").style.display = "none";
      document.getElementById("loginSection").style.display = "block";
    }

    function searchPatients() {
      const searchValue = document.getElementById('searchPatient').value.toLowerCase();
      const tableBody = document.getElementById('patientsTable');
      const rows = tableBody.getElementsByTagName('tr');

      Array.from(rows).forEach(row => {
        const cells = row.getElementsByTagName('td');
        const rowData = Array.from(cells)
          .map(cell => cell.textContent.toLowerCase())
          .join(' ');
        if (rowData.includes(searchValue)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    function filterPatients() {
      const searchValue = document.getElementById('searchPatient').value.toLowerCase().trim();
      const filterStatus = document.getElementById('filterStatus').value.trim(); // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
      const filterDrugIssues = document.getElementById('filterDrugIssues').value.trim(); // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤
      const tableBody = document.getElementById('patientsTable');
      const rows = tableBody.getElementsByTagName('tr');

      let filteredCount = 0; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á

      Array.from(rows).forEach(row => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß Group By ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const isGroupRow = row.getAttribute('data-group') === 'true';

        if (isGroupRow) {
          row.style.display = ''; // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ß Group By ‡πÄ‡∏™‡∏°‡∏≠
          return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ
        }

        const cells = row.getElementsByTagName('td');
        const name = cells[0]?.textContent.toLowerCase().trim() || ''; // ‡∏ä‡∏∑‡πà‡∏≠
        const status = cells[2]?.textContent.replace(/‚ö†Ô∏è/g, '').trim() || ''; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
        const drugIssues = cells[3]?.textContent.trim() || ''; // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤

        const matchesSearch = !searchValue || name.includes(searchValue);
        const matchesStatus = !filterStatus || status === filterStatus;
        const matchesDrugIssues = !filterDrugIssues || drugIssues === filterDrugIssues;

        if (matchesSearch && matchesStatus && matchesDrugIssues) {
          row.style.display = ''; // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
          filteredCount++; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
        } else {
          row.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
        }
      });

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
      document.getElementById('filteredCount').textContent = `‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${filteredCount}`;
    }
    function openCareForm(index) {
      const patient = patients[index];
      const careFormHtml = `
        <div>
          <h4>‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•‡∏ó‡∏≤‡∏á‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏°: ${patient.name}</h4>
          <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</label>
          <textarea id="medication" class="form-control" rows="4" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ ‡πÄ‡∏ä‡πà‡∏ô Paracetamol 500 mg 1 ‡πÄ‡∏°‡πá‡∏î ‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô"></textarea>
          <label>‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</label>
          <input type="text" id="allergy" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤">
          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•:</label>
          <textarea id="careDetails" class="form-control" rows="4" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>
          <button class="btn btn-success mt-3" onclick="savePharmaceuticalCare(${index})">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button class="btn btn-secondary mt-3" onclick="cancelCareForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      `;

      Swal.fire({
        title: '‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•‡∏ó‡∏≤‡∏á‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏°',
        html: careFormHtml,
        showConfirmButton: false,
      });
    }

    function cancelCareForm() {
      Swal.close();
    }

    function savePharmaceuticalCare(index) {
      const patient = patients[index];
      const careData = {
        medication: document.getElementById('medication').value,
        allergy: document.getElementById('allergy').value,
        details: document.getElementById('careDetails').value,
      };

      if (!careData.medication || !careData.allergy || !careData.details) {
        Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "", "warning");
        return;
      }

      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
      });

      google.script.run.withSuccessHandler(response => {
        Swal.close();
        if (response.success) {
          Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", response.message, "success");
        } else {
          Swal.fire("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", response.message, "error");
        }
      }).savePharmaceuticalCare(patient.uniqueId, careData);
    }

    function viewCareDetails(index) {
      const patient = patients[index];

      if (!patient.uniqueId) {
        Swal.fire("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏ö UniqueID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ", "error");
        return;
      }

      // ‡πÅ‡∏™‡∏î‡∏á Loading
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
      });

      google.script.run.withSuccessHandler(response => {
        Swal.close();

        let data;
        
        try {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ response ‡πÄ‡∏õ‡πá‡∏ô Object ‡∏´‡∏£‡∏∑‡∏≠ String
          if (typeof response === "string") {
            data = JSON.parse(response);  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string, ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON
          } else {
            data = response;  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô object ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          }
        } catch (error) {
          console.error("JSON Parse Error:", error, response);
          Swal.fire("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
          return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!data || !data.success || !data.history || data.history.length === 0) {
          Swal.fire({
            title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•',
            text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ',
            icon: 'info'
          });
          return;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        const formatTimestamp = (timestamp) => {
          const dateObj = new Date(timestamp);
          const day = String(dateObj.getDate()).padStart(2, '0');
          const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0
          const year = dateObj.getFullYear();
          const hours = String(dateObj.getHours()).padStart(2, '0');
          const minutes = String(dateObj.getMinutes()).padStart(2, '0');
          return `${day}-${month}-${year} ‡πÄ‡∏ß‡∏•‡∏≤ ${hours}:${minutes}`;
        };

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const careDetailsHtml = data.history.map((care, i) => `
          <div>
            <h5>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${i + 1}</h5>
            <p><strong>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</strong> ${care.medication || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
            <p><strong>‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</strong> ${care.allergy || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
            <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${care.careDetails || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ${care.timestamp ? formatTimestamp(care.timestamp) : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
            <button class="btn btn-danger btn-sm mt-2" onclick="deleteCareRecord('${patient.uniqueId}', ${i},${index})">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <hr>
          </div>
        `).join('');

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô Modal
        document.getElementById('careDetailsContent').innerHTML = careDetailsHtml;

        // ‡πÅ‡∏™‡∏î‡∏á Modal
        const modal = new bootstrap.Modal(document.getElementById('careDetailsModal'));
        modal.show();

      }).getPharmaceuticalHistory(patient.uniqueId);
    }


    function loadUserStatistics() {
      if (!currentUser || !currentUser.username) {
        console.error("currentUser ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ username");
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏™‡∏ß‡∏á‡∏ö‡∏∏‡∏ç‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        return;
      }

      if (currentUser.hospital === 'Admin') {
        const screeningButton = document.querySelector('button[onclick="toggleEditInputs()"]');
        if (screeningButton) {
          screeningButton.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á
        }
        const editInputs = document.getElementById('editInputs');
        if (editInputs) {
          editInputs.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        }
      }

      google.script.run.withSuccessHandler(response => {
        if (response.success) {
          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å response
          const totalPilgrims = response.totalPilgrims;
          const pilgrimsInCharge = response.pilgrimsInCharge;
          const pilgrimsScreened = response.pilgrimsScreened;

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
          const responsiblePercentage = ((pilgrimsInCharge / totalPilgrims) * 100).toFixed(2);
          const screenedPercentage = ((pilgrimsScreened / pilgrimsInCharge) * 100).toFixed(2);
          const screenedTotalPercentage = ((pilgrimsScreened / totalPilgrims) * 100).toFixed(2);

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DOM
          document.getElementById('totalPilgrims').textContent = totalPilgrims;
          document.getElementById('pilgrimsInCharge').textContent = pilgrimsInCharge;
          document.getElementById('pilgrimsScreened').textContent = pilgrimsScreened;
          document.getElementById('responsiblePercentage').textContent = `${responsiblePercentage}%`;
          document.getElementById('screenedPercentage').textContent = `${screenedPercentage}%`;
          document.getElementById('screenedTotalPercentage').textContent = `${screenedTotalPercentage}%`;
        } else {
          Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', response.message, 'error');
        }
      }).getUserStatistics(currentUser.username, currentUser.hospital === 'Admin');
    }



    function updatePilgrimData() {
      const newInCharge = parseInt(document.getElementById('editPilgrimsInCharge').value.trim(), 10);
      const newScreened = parseInt(document.getElementById('editPilgrimsScreened').value.trim(), 10);

      if (isNaN(newInCharge) || isNaN(newScreened)) {
        Swal.fire("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "error");
        return;
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô Google Sheets ‡∏ú‡πà‡∏≤‡∏ô Google Apps Script
      const data = {
        username: currentUser.username,
        pilgrimsInCharge: newInCharge,
        pilgrimsScreened: newScreened,
      };

      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
      });

      google.script.run
        .withSuccessHandler(response => {
          Swal.close();
          if (response.success) {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô UI
            document.getElementById('pilgrimsInCharge').textContent = newInCharge;
            document.getElementById('pilgrimsScreened').textContent = newScreened;

            const totalPilgrims = parseInt(document.getElementById('totalPilgrims').textContent, 10);
            const responsiblePercentage = ((newInCharge / totalPilgrims) * 100).toFixed(2);
            const screenedPercentage = ((newScreened / newInCharge) * 100).toFixed(2);
            const screenedTotalPercentage = ((newScreened / totalPilgrims) * 100).toFixed(2);

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÉ‡∏ô UI
            document.getElementById('responsiblePercentage').textContent = `${responsiblePercentage}%`;
            document.getElementById('screenedPercentage').textContent = `${screenedPercentage}%`;
            document.getElementById('screenedTotalPercentage').textContent = `${screenedTotalPercentage}%`;

            const editInputs = document.getElementById('editInputs');
            editInputs.style.display = 'none';

            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", response.message, "success");
          } else {
            Swal.fire("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", response.message, "error");
          }
        })
        .withFailureHandler(error => {
          Swal.close();
          console.error('Error:', error);
          Swal.fire("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
        })
        .updateUserStatistics(data);
    }



    function showPilgrimChart() {
      Swal.fire({
        title: '‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏™‡∏ß‡∏á‡∏ö‡∏∏‡∏ç',
        html: '<canvas id="popupPilgrimsChart" width="400" height="200"></canvas>',
        showCloseButton: true,
        showConfirmButton: false,
        width: '600px',
        didOpen: () => {
          const canvasElement = document.getElementById('popupPilgrimsChart');
          if (!canvasElement) {
            console.error("Canvas element ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô DOM");
            return;
          }

          const ctx = canvasElement.getContext('2d');

          // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DOM
          const totalPilgrims = parseInt(document.getElementById('totalPilgrims').textContent, 10);
          const pilgrimsInCharge = parseInt(document.getElementById('pilgrimsInCharge').textContent, 10);
          const pilgrimsScreened = parseInt(document.getElementById('pilgrimsScreened').textContent, 10);

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
          const responsiblePercentage = ((pilgrimsInCharge / totalPilgrims) * 100).toFixed(2);
          const screenedPercentage = ((pilgrimsScreened / pilgrimsInCharge) * 100).toFixed(2);
          const screenedTotalPercentage = ((pilgrimsScreened / totalPilgrims) * 100).toFixed(2);

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: [
                '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö',
                '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á (‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö)',
                '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)'
              ],
              datasets: [{
                label: '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)',
                data: [responsiblePercentage, screenedPercentage, screenedTotalPercentage],
                backgroundColor: ['#28a745', '#ffc107', '#007bff'],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100
                }
              }
            }
          });
        }
      });
    }

    function toggleEditInputs() {
      const editInputs = document.getElementById('editInputs');
      const pilgrimsInCharge = document.getElementById('pilgrimsInCharge').textContent.trim();
      const pilgrimsScreened = document.getElementById('pilgrimsScreened').textContent.trim();

      if (editInputs.style.display === 'none') {
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö input
        document.getElementById('editPilgrimsInCharge').value = pilgrimsInCharge;
        document.getElementById('editPilgrimsScreened').value = pilgrimsScreened;

        // ‡πÅ‡∏™‡∏î‡∏á input
        editInputs.style.display = 'flex';
      } else {
        // ‡∏ã‡πà‡∏≠‡∏ô input
        editInputs.style.display = 'none';
      }
    }

    function deleteCareRecord(uniqueId, careIndex, index) {
      Swal.fire({
        title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?",
        text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "‡∏•‡∏ö",
        cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          google.script.run
            .withSuccessHandler((response) => {
              Swal.close();
              if (response.success) {
                Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
                closeViewCareDetails();
              } else {
                Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", response.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
              }
            })
            .deletePharmaceuticalCare(uniqueId, careIndex);
        }
      });
    }

    function closeViewCareDetails() {
      // ‡∏õ‡∏¥‡∏î Modal `careDetailsModal`
      let careDetailsModal = bootstrap.Modal.getInstance(document.getElementById('careDetailsModal'));
      if (careDetailsModal) {
          careDetailsModal.hide();
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ mainSection ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î Modal
      document.getElementById('mainSection').style.display = 'block';
   }


</script>